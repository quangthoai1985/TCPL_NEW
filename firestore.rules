
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Bất kỳ ai cũng có thể đọc cấu hình chung (VD: trang đăng nhập)
    match /configurations/{configId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'admin'; // Chỉ admin được ghi
    }

    // Bất kỳ ai cũng có thể đọc các văn bản hướng dẫn
    match /guidanceDocuments/{docId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'admin'; // Chỉ admin được ghi
    }

    // Bất kỳ ai đăng nhập cũng có thể đọc cấu hình chung
    match /assessmentPeriods/{periodId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin'; // Chỉ admin được ghi
    }

    match /criteria/{criterionId} {
      allow read: if request.auth != null;
      allow write: if false; // Chỉ cho phép Admin/Functions ghi
      
      match /indicators/{indicatorId} {
        allow read: if request.auth != null;
        allow write: if false; // Chỉ cho phép Admin/Functions ghi
      }
    }

    // Quy tắc cho collection 'users'
    match /users/{userId} {
      // Admin có thể đọc/liệt kê tất cả người dùng
      allow list, get: if request.auth != null && request.auth.token.role == 'admin';
      // Người dùng chỉ có thể đọc thông tin của chính mình
      allow read: if request.auth != null && request.auth.uid == userId;
      // Chỉ Cloud Function (syncUserClaims) mới được ghi để đảm bảo an toàn
      allow write: if false; 
    }

    match /units/{unitId} {
      allow read: if true;
      allow write: if false; // Chỉ cho phép Admin/Functions ghi
    }

    // Quy tắc cho collection 'assessments'
    match /assessments/{assessmentId} {
      // Phân tích assessmentId để lấy communeId
      function getCommuneIdFromAssessmentId() {
        return assessmentId.split('_')[2];
      }

            allow read, write: if request.auth != null &&

                                (request.auth.token.role == 'admin' ||

                                 (request.auth.token.role == 'commune_staff' && resource.data.communeId == request.auth.token.communeId));    }

    // Quy tắc cho collection 'signature_checks'
    // Chỉ cho phép backend (Cloud Functions) ghi vào đây
    match /signature_checks/{checkId} {
      allow read: if request.auth != null && request.auth.token.role == 'admin'; // Admin có thể xem logs
      allow write: if false; // Không client nào được ghi trực tiếp
    }
  }
}
